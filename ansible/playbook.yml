---
- name: Set up container environment with Python 3
  hosts: webserver
  become: true
  gather_facts: true

  vars:
    ansible_python_interpreter: /usr/bin/python3  # Spécifier l'interpréteur Python 3

  tasks:
    - name: Check if Python 3 is installed
      command: which python3
      register: python3_installed
      ignore_errors: true

    - name: Ensure Python 3 is installed
      ansible.builtin.apt:
        name: python3
        state: present
      when: python3_installed.rc != 0

    - name: Check if pip for Python 3 is installed
      command: which pip3
      register: pip3_installed
      ignore_errors: true

    - name: Ensure pip for Python 3 is installed
      ansible.builtin.apt:
        name: python3-pip
        state: present
      when: pip3_installed.rc != 0

    - name: Check if Ansible is installed
      command: ansible --version
      register: ansible_installed
      ignore_errors: true

    - name: Install Ansible 2.9.0 on the VM
      ansible.builtin.pip:
        name: ansible==2.9.0
        executable: /home/secureadmin/.local/bin/pip3
        state: present
      when: ansible_installed.rc != 0

    - name: Ensure Ansible version is correct
      command: ansible --version
      register: ansible_version_output
      changed_when: false

    - name: Debug Ansible version
      ansible.builtin.debug:
        var: ansible_version_output.stdout

    # Ajouter les rôles pour configurer le serveur web
    - name: Include roles for webserver setup
      ansible.builtin.include_role:
        name: common

    - name: Include docker role
      ansible.builtin.include_role:
        name: docker

    - name: Include keycloak role
      ansible.builtin.include_role:
        name: keycloak

    - name: Include webserver role
      ansible.builtin.include_role:
        name: webserver
