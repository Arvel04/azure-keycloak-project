---
- name: Configure VM and set up webserver
  hosts: localhost
  become: true
  gather_facts: true

  tasks:
    - name: Ensure permissions for ansible directory
      ansible.builtin.file:
        path: /home/secureadmin/ansible
        state: directory
        mode: '0755'
        owner: secureadmin
        group: secureadmin
        recurse: yes

    - name: Ensure permissions for ansible.cfg file
      ansible.builtin.file:
        path: /home/secureadmin/ansible/ansible.cfg
        state: file
        mode: '0644'
        owner: secureadmin
        group: secureadmin

    - name: Ensure permissions for hosts file
      ansible.builtin.file:
        path: /home/secureadmin/ansible/hosts
        state: file
        mode: '0644'
        owner: secureadmin
        group: secureadmin

    - name: Ensure permissions for playbook.yml file
      ansible.builtin.file:
        path: /home/secureadmin/ansible/playbook.yml
        state: file
        mode: '0644'
        owner: secureadmin
        group: secureadmin

    - name: Ensure permissions for common role
      ansible.builtin.file:
        path: /home/secureadmin/ansible/roles/common
        state: directory
        mode: '0755'
        owner: secureadmin
        group: secureadmin
        recurse: yes

    - name: Ensure permissions for docker role
      ansible.builtin.file:
        path: /home/secureadmin/ansible/roles/docker
        state: directory
        mode: '0755'
        owner: secureadmin
        group: secureadmin
        recurse: yes

    - name: Ensure permissions for keycloak role
      ansible.builtin.file:
        path: /home/secureadmin/ansible/roles/keycloak
        state: directory
        mode: '0755'
        owner: secureadmin
        group: secureadmin
        recurse: yes

    - name: Ensure permissions for webserver role
      ansible.builtin.file:
        path: /home/secureadmin/ansible/roles/webserver
        state: directory
        mode: '0755'
        owner: secureadmin
        group: secureadmin
        recurse: yes

    - name: Ensure Python 3 is installed
      ansible.builtin.apt:
        name: python3
        state: present

    - name: Ensure pip for Python 3 is installed
      ansible.builtin.apt:
        name: python3-pip
        state: present

    - name: Ensure Python dependencies are installed
      ansible.builtin.apt:
        name:
          - python3-dev
          - build-essential
          - libssl-dev
          - libffi-dev
          - python3-setuptools
        state: present

    - name: Check if Ansible is installed
      command: ansible --version
      register: ansible_installed
      ignore_errors: true

    - name: Install Ansible 2.9.0 on the VM
      command: pip3 install ansible==2.9.0
      when: ansible_installed.rc != 0

    - name: Ensure Ansible version is correct
      command: ansible --version
      register: ansible_version_output
      changed_when: false

    - name: Debug Ansible version
      ansible.builtin.debug:
        var: ansible_version_output.stdout

    - name: Include roles for webserver setup
      ansible.builtin.include_role:
        name: common

    - name: Include docker role
      ansible.builtin.include_role:
        name: docker

    - name: Include keycloak role
      ansible.builtin.include_role:
        name: keycloak

    - name: Include webserver role
      ansible.builtin.include_role:
        name: webserver
